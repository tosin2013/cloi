name: AI-Powered Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [ main, develop ]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  models: read

jobs:
  ai-code-review:
    name: AI Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(js|cjs|mjs|py)$' | head -10)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: AI Code Review for Core Logic
        if: steps.changed-files.outputs.files != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read changed files and analyze with AI
          changed_files="${{ steps.changed-files.outputs.files }}"
          
          for file in $changed_files; do
            if [[ -f "$file" ]]; then
              echo "Analyzing $file..."
              
              # Get the diff for this file
              diff_content=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- "$file")
              
              # Skip if diff is too large (>4000 chars to stay within API limits)
              if [[ ${#diff_content} -gt 4000 ]]; then
                echo "Skipping $file - diff too large"
                continue
              fi
              
              # Check if this touches core logic
              core_logic_check=""
              if [[ "$file" == src/core/* ]] || [[ "$file" == src/rag/* ]]; then
                core_logic_check="CRITICAL: This file is part of the core logic. Pay special attention to: 1) Breaking changes 2) Security implications 3) Performance impact 4) API compatibility"
              fi
              
              # Prepare the review prompt
              review_prompt="You are a senior software engineer reviewing code for the Cloi project - a security-first agentic debugging tool. 
              
              $core_logic_check
              
              Please review this code change and provide:
              1. Security considerations (especially for API keys, user input, file access)
              2. Code quality assessment
              3. Potential bugs or issues
              4. Performance implications
              5. Suggestions for improvement
              
              Be concise but thorough. Focus on actionable feedback.
              
              File: $file
              
              Diff:
              $diff_content"
              
              # Call GitHub Models API
              response=$(curl -s "https://models.github.ai/inference/chat/completions" \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -d "{
                  \"messages\": [
                    {
                      \"role\": \"user\",
                      \"content\": $(echo "$review_prompt" | jq -Rs .)
                    }
                  ],
                  \"model\": \"openai/gpt-4o\"
                }")
              
              # Extract the review content
              review_content=$(echo "$response" | jq -r '.choices[0].message.content' 2>/dev/null || echo "Failed to get AI review")
              
              # Post as PR comment
              comment_body="## ü§ñ AI Code Review for \`$file\`

              $review_content

              ---
              *This review was generated using GitHub Models. Please use your judgment and consider this as additional input to human review.*"
              
              # Create the comment
              curl -s -X POST \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Content-Type: application/json" \
                "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
                -d "{\"body\": $(echo "$comment_body" | jq -Rs .)}"
              
              echo "Posted AI review for $file"
              
              # Rate limit protection
              sleep 2
            fi
          done

  ai-security-analysis:
    name: AI Security Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get security-sensitive files
        id: security-files
        run: |
          # Look for changes in security-sensitive areas
          SECURITY_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '(apiKeyManager|auth|security|credential|secret|token)' || true)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$SECURITY_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: AI Security Review
        if: steps.security-files.outputs.files != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          security_files="${{ steps.security-files.outputs.files }}"
          
          if [[ -n "$security_files" ]]; then
            echo "Security-sensitive files detected: $security_files"
            
            # Get combined diff for security analysis
            security_diff=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- $security_files)
            
            if [[ ${#security_diff} -gt 3000 ]]; then
              security_diff=$(echo "$security_diff" | head -c 3000)
              security_diff="$security_diff... (truncated)"
            fi
            
            security_prompt="You are a cybersecurity expert reviewing code changes for the Cloi project.
            
            CRITICAL SECURITY REVIEW NEEDED
            
            Please analyze these changes for:
            1. Credential exposure or hardcoded secrets
            2. API key handling and storage
            3. Input validation and sanitization
            4. Authentication and authorization flaws
            5. Injection vulnerabilities
            6. File system access security
            7. Network request security
            
            Provide specific, actionable security recommendations.
            
            Changes in security-sensitive files:
            $security_diff"
            
            response=$(curl -s "https://models.github.ai/inference/chat/completions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -d "{
                \"messages\": [
                  {
                    \"role\": \"user\",
                    \"content\": $(echo "$security_prompt" | jq -Rs .)
                  }
                ],
                \"model\": \"openai/gpt-4o\"
              }")
            
            security_review=$(echo "$response" | jq -r '.choices[0].message.content' 2>/dev/null || echo "Failed to get security review")
            
            comment_body="## üîí AI Security Analysis

            **‚ö†Ô∏è Security-sensitive files were modified in this PR**

            $security_review

            ### Recommended Actions:
            - [ ] Manual security review by security team
            - [ ] Run security tests
            - [ ] Verify no credentials are exposed
            - [ ] Check API key handling

            ---
            *This security analysis was generated using GitHub Models. Manual security review is still required.*"
            
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              -d "{\"body\": $(echo "$comment_body" | jq -Rs .)}"
          fi

  ai-test-suggestions:
    name: AI Test Suggestions
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Analyze changes for test coverage
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get all changed JavaScript files
          changed_js_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(js|cjs|mjs)$' | grep -v test | head -5)
          
          if [[ -n "$changed_js_files" ]]; then
            echo "Analyzing test coverage for: $changed_js_files"
            
            # Read the actual file contents
            file_contents=""
            for file in $changed_js_files; do
              if [[ -f "$file" ]]; then
                file_content=$(head -c 2000 "$file")
                file_contents="$file_contents

                File: $file
                Content:
                $file_content"
              fi
            done
            
            test_prompt="You are a test engineering expert for the Cloi project.
            
            Please analyze these code changes and suggest:
            1. Unit tests that should be written
            2. Integration tests for the CodeBERT service interaction
            3. Edge cases to test
            4. Security test scenarios
            5. Performance test considerations
            
            Focus on practical, implementable test suggestions. Consider that this is a CLI tool that interacts with LLMs and processes code.
            
            Changed files:
            $file_contents"
            
            response=$(curl -s "https://models.github.ai/inference/chat/completions" \
              -H "Content-Type: application/json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -d "{
                \"messages\": [
                  {
                    \"role\": \"user\",
                    \"content\": $(echo "$test_prompt" | jq -Rs .)
                  }
                ],
                \"model\": \"openai/gpt-4o\"
              }")
            
            test_suggestions=$(echo "$response" | jq -r '.choices[0].message.content' 2>/dev/null || echo "Failed to get test suggestions")
            
            comment_body="## üß™ AI Test Suggestions

            $test_suggestions

            ### Next Steps:
            - [ ] Implement suggested unit tests
            - [ ] Add integration tests if applicable
            - [ ] Consider edge cases mentioned above
            - [ ] Update test documentation

            ---
            *These test suggestions were generated using GitHub Models to help improve code coverage.*"
            
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              -d "{\"body\": $(echo "$comment_body" | jq -Rs .)}"
          fi

  github-copilot-review:
    name: GitHub Copilot Code Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Install GitHub CLI and Copilot
        run: |
          # Install GitHub CLI if not already available
          type gh >/dev/null 2>&1 || {
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          }
          
          # Install GitHub Copilot CLI extension
          gh extension install github/gh-copilot || true
      
      - name: Get changed files for Copilot review
        id: copilot-files
        run: |
          # Get list of changed files (limit to avoid token limits)
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(js|cjs|mjs|py|yml|yaml)$' | head -5)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: GitHub Copilot Code Analysis
        if: steps.copilot-files.outputs.files != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          changed_files="${{ steps.copilot-files.outputs.files }}"
          
          # Create a summary of all changes for Copilot
          echo "ü§ñ GitHub Copilot Review Summary" > copilot_review.md
          echo "===========================================" >> copilot_review.md
          echo "" >> copilot_review.md
          
          for file in $changed_files; do
            if [[ -f "$file" ]]; then
              echo "üìÑ Analyzing: $file" >> copilot_review.md
              echo "---" >> copilot_review.md
              
              # Get file diff
              diff_content=$(git diff ${{ github.event.pull_request.base.sha }} ${{ github.sha }} -- "$file")
              
              # Use GitHub Copilot CLI to explain the changes
              if [[ ${#diff_content} -lt 2000 ]]; then
                echo "**What changed:**" >> copilot_review.md
                echo '```diff' >> copilot_review.md
                echo "$diff_content" >> copilot_review.md
                echo '```' >> copilot_review.md
                echo "" >> copilot_review.md
                
                # Use Copilot to suggest improvements (if available)
                gh copilot suggest "Review this code change and suggest improvements: $diff_content" 2>/dev/null | head -20 >> copilot_review.md || echo "üí° Manual review recommended for complex changes" >> copilot_review.md
                echo "" >> copilot_review.md
              else
                echo "‚ö†Ô∏è Large diff detected - manual review recommended" >> copilot_review.md
                echo "" >> copilot_review.md
              fi
            fi
          done
          
          # Post Copilot review as PR comment
          if [[ -s copilot_review.md ]]; then
            review_content=$(cat copilot_review.md)
            
            comment_body="## ü§ñ GitHub Copilot Code Review

            $review_content

            ### üéØ Copilot Recommendations:
            - Run \`gh copilot suggest\` locally for interactive suggestions
            - Use \`gh copilot explain\` to understand complex code sections
            - Consider using GitHub Copilot in your IDE for real-time assistance

            ---
            *This review combines GitHub Copilot CLI analysis with automated diff review.*"
            
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
              -d "{\"body\": $(echo "$comment_body" | jq -Rs .)}"
          fi

  workflow-syntax-validation:
    name: Workflow Syntax Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate workflow file syntax
        run: |
          # Check for changes in workflow files
          workflow_files=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.github/workflows/.*\.ya?ml$' || true)
          
          if [[ -n "$workflow_files" ]]; then
            echo "üîç Validating workflow syntax for: $workflow_files"
            
            for workflow in $workflow_files; do
              if [[ -f "$workflow" ]]; then
                echo "Validating $workflow..."
                
                # Basic YAML syntax validation
                python3 -c "
                import yaml
                import sys
                
                try:
                    with open('$workflow', 'r') as f:
                        yaml.safe_load(f)
                    print('‚úÖ $workflow: Valid YAML syntax')
                except yaml.YAMLError as e:
                    print('‚ùå $workflow: YAML syntax error - ', e)
                    sys.exit(1)
                except Exception as e:
                    print('‚ö†Ô∏è $workflow: Could not validate - ', e)
                "
                
                # Check for common workflow issues
                if grep -q "if.*fi" "$workflow"; then
                  if ! grep -Pzo "if.*\n.*fi" "$workflow" >/dev/null; then
                    echo "‚ö†Ô∏è Potential bash syntax issue detected in $workflow - check if/fi pairing"
                  fi
                fi
                
                # Workflow validation completed
                echo "‚úÖ $workflow syntax validation completed"
              fi
            done
          else
            echo "‚ÑπÔ∏è No workflow files changed in this PR"
          fi